<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampusCoins - Debug Roles</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <header>
        <h1>CampusCoins Role Debugger</h1>
    </header>
    
    <div class="container">
        <div class="card">
            <h2>Role Detection Debug</h2>
            <p>Connected Wallet: <span id="walletAddress">Not connected</span></p>
            <p>Detected Role: <span id="detectedRole">None</span></p>
            
            <div id="transactionStatus" class="transaction-status"></div>
            
            <button class="btn btn-primary" id="connectWallet">Connect Wallet</button>
            <button class="btn btn-success" style="display: none;" id="checkRole">Check Role</button>
            
            <div style="margin-top: 20px;">
                <h3>Role Mappings</h3>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #f2f2f2;">
                            <th style="text-align: left; padding: 8px; border: 1px solid #ddd;">Address</th>
                            <th style="text-align: left; padding: 8px; border: 1px solid #ddd;">Role</th>
                        </tr>
                    </thead>
                    <tbody id="roleTable">
                        <!-- Role mappings will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
    <script>
        let web3;
        let userAccount;
        let userRole;
        
        // Role mappings from Ganache accounts
        const ROLE_MAPPINGS = {
            '0x10787572daaE58789b74b131c48EF4e93E00dA06': 'admin',
            '0x4977451329D69861613A220837b2f1C61F31C531': 'organizer',
            '0xFCEe892f01345D3364a86c79Ac2C1CD7c53da0Cd': 'organizer',
            '0x9c86495CF5d83Af41a376E1865dac9F3E127a688': 'canteen',
            '0xCa5D12aE19785C30a4Dc90aD26B96DC00e2053eB': 'canteen',
            '0x839B74A47a63e4cDdfB02a52EcD98c4aB23183fe': 'student',
            '0xC9ecEf5042F913c65AA0Fcd81E0D6202f90DE2f7': 'student',
            '0xFe9b60BE72C7666901303732d37aF49B09871c35': 'student',
            '0x1D9CE4f79d7ccFD9cf08Eb747c610C6c045d1B94': 'student',
            '0xb0059F146C41178960684b1F74d8e6c3e1E204b8': 'student',
        };
        
        async function connectWallet() {
            if (window.ethereum) {
                try {
                    web3 = new Web3(window.ethereum);
                    const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                    userAccount = accounts[0];
                    
                    document.getElementById('walletAddress').innerText = userAccount;
                    document.getElementById('connectWallet').style.display = 'none';
                    document.getElementById('checkRole').style.display = 'inline-block';
                    
                    checkRole();
                    
                } catch (error) {
                    console.error("Connection error:", error);
                    showStatus("Could not connect to MetaMask. Please make sure it is installed and unlocked.", true);
                }
            } else {
                showStatus("Please install MetaMask!", true);
            }
        }
        
        function checkRole() {
            if (!userAccount) return;
            
            // Ensure we get the case-insensitive comparison
            const formattedAccount = userAccount.toLowerCase();
            
            // Find the matching address in our role mappings
            let foundRole = null;
            for (const [address, role] of Object.entries(ROLE_MAPPINGS)) {
                if (address.toLowerCase() === formattedAccount) {
                    userRole = role;
                    foundRole = role;
                    break;
                }
            }
            
            // Default to student if no role found
            if (!foundRole) {
                userRole = 'student';
            }
            
            document.getElementById('detectedRole').innerText = userRole;
            showStatus(`Role detected: ${userRole} for account ${userAccount}`);
        }
        
        function showStatus(message, isError = false) {
            const statusElement = document.getElementById('transactionStatus');
            statusElement.innerText = message;
            statusElement.className = isError ? 'transaction-status error' : 'transaction-status success';
            statusElement.style.display = 'block';
            
            // Hide status after 5 seconds
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }
        
        function populateRoleTable() {
            const tableBody = document.getElementById('roleTable');
            
            for (const [address, role] of Object.entries(ROLE_MAPPINGS)) {
                const row = document.createElement('tr');
                
                const addressCell = document.createElement('td');
                addressCell.style.padding = '8px';
                addressCell.style.border = '1px solid #ddd';
                addressCell.textContent = address;
                
                const roleCell = document.createElement('td');
                roleCell.style.padding = '8px';
                roleCell.style.border = '1px solid #ddd';
                roleCell.textContent = role;
                
                row.appendChild(addressCell);
                row.appendChild(roleCell);
                tableBody.appendChild(row);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('connectWallet').addEventListener('click', connectWallet);
            document.getElementById('checkRole').addEventListener('click', checkRole);
            
            populateRoleTable();
        });
    </script>
</body>
</html>
