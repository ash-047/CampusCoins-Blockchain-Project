<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampusCoins - Debug Roles</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <header>
        <h1>CampusCoins Role Debugger</h1>
    </header>
    
    <div class="container">
        <div class="card">
            <h2>Role Detection Debug</h2>
            <p>Connected Wallet: <span id="walletAddress">Not connected</span></p>
            <p>Detected Role: <span id="detectedRole">None</span></p>
            
            <div id="transactionStatus" class="transaction-status"></div>
            
            <button class="btn btn-primary" id="connectWallet">Connect Wallet</button>
            <button class="btn btn-success" style="display: none;" id="checkRole">Check Role</button>
            
            <div style="margin-top: 20px;">
                <h3>Role Mappings</h3>
                <table class="activity-table">
                    <thead>
                        <tr>
                            <th>Address</th>
                            <th>Role</th>
                            <th>Display Name</th>
                        </tr>
                    </thead>
                    <tbody id="roleTable">
                        <!-- Role mappings will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        let web3;
        let userAccount;
        let userRole;
        let allAccounts = [];
        
        async function connectWallet() {
            if (window.ethereum) {
                try {
                    web3 = new Web3(window.ethereum);
                    const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                    userAccount = accounts[0];
                    
                    document.getElementById('walletAddress').innerText = userAccount;
                    document.getElementById('connectWallet').style.display = 'none';
                    document.getElementById('checkRole').style.display = 'inline-block';
                    
                    checkRole();
                    
                } catch (error) {
                    console.error("Connection error:", error);
                    showStatus("Could not connect to MetaMask. Please make sure it is installed and unlocked.", true);
                }
            } else {
                showStatus("Please install MetaMask!", true);
            }
        }
        
        async function checkRole() {
            if (!userAccount) return;
            
            try {
                // Get contract ABI and instantiate contract
                if (!campusCoinContract) {
                    const response = await fetch('/contract-abi');
                    const abi = await response.json();
                    campusCoinContract = new web3.eth.Contract(abi, CONTRACT_ADDRESS);
                }
                
                // Verify roles from the blockchain
                // Check if admin
                const adminAddress = await campusCoinContract.methods.admin().call();
                if (userAccount.toLowerCase() === adminAddress.toLowerCase()) {
                    userRole = 'admin';
                } else {
                    // Check if organizer
                    const isOrganizer = await campusCoinContract.methods.isOrganizer(userAccount).call();
                    if (isOrganizer) {
                        userRole = 'organizer';
                    } else {
                        // Check if canteen staff
                        const isCanteen = await campusCoinContract.methods.isCanteenStaff(userAccount).call();
                        if (isCanteen) {
                            userRole = 'canteen';
                        } else {
                            // Default to student
                            userRole = 'student';
                        }
                    }
                }
                
                document.getElementById('detectedRole').innerText = userRole;
                showStatus(`Role detected: ${userRole} for account ${userAccount}`);
            } catch (error) {
                console.error("Error checking role:", error);
                showStatus(`Error checking role: ${error.message}`, true);
            }
        }
        
        function showStatus(message, isError = false) {
            const statusElement = document.getElementById('transactionStatus');
            statusElement.innerText = message;
            statusElement.className = isError ? 'transaction-status error' : 'transaction-status success';
            statusElement.style.display = 'block';
            
            // Hide status after 5 seconds
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }
        
        async function populateRoleTable() {
            try {
                const response = await fetch('/accounts');
                const data = await response.json();
                
                if (data.error) {
                    showStatus(`Error loading accounts: ${data.error}`, true);
                    return;
                }
                
                allAccounts = data.accounts;
                const tableBody = document.getElementById('roleTable');
                tableBody.innerHTML = '';
                
                for (const account of allAccounts) {
                    const row = document.createElement('tr');
                    
                    const addressCell = document.createElement('td');
                    addressCell.textContent = account.address;
                    
                    const roleCell = document.createElement('td');
                    roleCell.textContent = account.role;
                    
                    const nameCell = document.createElement('td');
                    nameCell.textContent = account.displayName;
                    
                    row.appendChild(addressCell);
                    row.appendChild(roleCell);
                    row.appendChild(nameCell);
                    tableBody.appendChild(row);
                }
                
                showStatus(`Loaded ${allAccounts.length} accounts successfully`);
            } catch (error) {
                console.error("Error loading accounts:", error);
                showStatus(`Error loading accounts: ${error.message}`, true);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('connectWallet').addEventListener('click', connectWallet);
            document.getElementById('checkRole').addEventListener('click', checkRole);
            
            populateRoleTable();
        });
    </script>
</body>
</html>
