<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampusCoins - Blockchain-Based Campus Reward System</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
</head>
<body>
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-body text-center">
                        <h1 class="mb-4">CampusCoins</h1>
                        <p class="lead">Blockchain-Based Campus Reward System</p>
                        <hr>
                        <p>Connect your MetaMask wallet to access your dashboard</p>
                        <button id="connectWallet" class="btn btn-primary btn-lg">Connect Wallet</button>
                        <div id="status" class="mt-3 alert" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const connectButton = document.getElementById('connectWallet');
            const statusElement = document.getElementById('status');

            function showStatus(message, type) {
                statusElement.textContent = message;
                statusElement.className = `mt-3 alert alert-${type}`;
                statusElement.style.display = 'block';
            }

            async function checkRole(address, contract) {
                try {
                    // Check roles directly from the contract
                    const adminAddress = await contract.methods.admin().call();
                    if (address.toLowerCase() === adminAddress.toLowerCase()) {
                        return 'admin';
                    }
                    
                    const isOrganizer = await contract.methods.isEventOrganizer(address).call();
                    if (isOrganizer) {
                        return 'organizer';
                    }
                    
                    const isCanteen = await contract.methods.isCanteenStaff(address).call();
                    if (isCanteen) {
                        return 'canteen';
                    }
                    
                    // Default role
                    return 'student';
                } catch (error) {
                    console.error("Error checking role:", error);
                    throw error;
                }
            }

            connectButton.addEventListener('click', async () => {
                if (typeof window.ethereum !== 'undefined') {
                    try {
                        showStatus('Connecting to wallet...', 'info');
                        
                        // Request account access
                        const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                        const userAddress = accounts[0];
                        
                        // Initialize Web3
                        const web3 = new Web3(window.ethereum);
                        
                        // Get contract address
                        const contractResponse = await fetch('/contract_address');
                        const contractData = await contractResponse.json();
                        const contractAddress = contractData.address;
                        
                        if (!contractAddress) {
                            showStatus('Contract address not set. Please deploy the contract first.', 'danger');
                            return;
                        }
                        
                        // Get minimum ABI to check roles
                        const minABI = [
                            {"inputs":[],"name":"admin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
                            {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"isEventOrganizer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
                            {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"isCanteenStaff","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"}
                        ];
                        
                        const contract = new web3.eth.Contract(minABI, contractAddress);
                        
                        showStatus('Checking role...', 'info');
                        const role = await checkRole(userAddress, contract);
                        
                        showStatus(`Role identified: ${role}. Redirecting...`, 'success');
                        
                        // Store the address in session storage
                        sessionStorage.setItem('walletAddress', userAddress);
                        
                        // Redirect to the appropriate dashboard
                        setTimeout(() => {
                            window.location.href = `/dashboard/${role}`;
                        }, 1000);
                        
                    } catch (error) {
                        showStatus(`Error: ${error.message}`, 'danger');
                    }
                } else {
                    showStatus('MetaMask is not installed! Please install it to use this application.', 'danger');
                }
            });
        });
    </script>
</body>
</html>
